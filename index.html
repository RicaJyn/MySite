<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Gallery</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Raleway:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f8f8;
            --text-primary: #2c2c2c;
            --text-secondary: #666666;
            --accent: #9b8b7e;
            --accent-hover: #7a6d62;
            --border: #e0e0e0;
            --shadow: rgba(0, 0, 0, 0.1);
            --overlay: rgba(0, 0, 0, 0.9);
            --z-dropdown: 2000;
            --z-modal: 3000;
            --z-lightbox: 4000;
            --z-nav: 1000;
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2a2a2a;
            --text-primary: #e8e8e8;
            --text-secondary: #a0a0a0;
            --accent: #b8a896;
            --accent-hover: #cbbead;
            --border: #3a3a3a;
            --shadow: rgba(0, 0, 0, 0.3);
            --overlay: rgba(0, 0, 0, 0.95);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Raleway', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: background 0.4s ease, color 0.4s ease;
            overflow-x: hidden;
            width: 100%;
        }

        /* --- Header --- */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: var(--z-nav);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .logo {
            font-family: 'Playfair Display', serif;
            font-size: 1.8rem;
            font-weight: 700;
            letter-spacing: 1px;
            color: var(--text-primary);
        }

        .header-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        /* --- Buttons --- */
        .btn {
            padding: 0.6rem 1.2rem;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-primary);
            font-family: 'Raleway', sans-serif;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            letter-spacing: 1px;
            text-transform: uppercase;
            border-radius: 4px;
        }

        .btn:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .btn-primary {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .btn-primary:hover {
            background: var(--accent-hover);
            border-color: var(--accent-hover);
        }

        .theme-toggle {
            background: none;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 1.5rem;
            padding: 0.5rem;
            transition: transform 0.3s ease;
        }

        .theme-toggle:hover {
            transform: rotate(180deg);
        }

        /* --- Layout --- */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 6rem 1.5rem 4rem;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- Dropdown (Fixed) --- */
        .album-selector-wrapper {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
            position: relative;
            z-index: var(--z-dropdown); /* High Z-Index to fix clicking issue */
        }

        .custom-select {
            position: relative;
            min-width: 300px;
            max-width: 100%;
        }

        .select-display {
            padding: 1rem 3rem 1rem 1.5rem;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            text-align: center;
            transition: all 0.3s ease;
            letter-spacing: 0.5px;
            position: relative;
            border-radius: 4px;
            user-select: none;
        }

        .select-display:hover {
            border-color: var(--accent);
        }

        .select-display::after {
            content: '‚ñº';
            position: absolute;
            right: 1.5rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.75rem;
            color: var(--text-secondary);
            transition: transform 0.3s ease;
        }

        .select-display.open::after {
            transform: translateY(-50%) rotate(180deg);
        }

        .select-options {
            position: absolute;
            top: calc(100% + 0.5rem);
            left: 0;
            right: 0;
            background: var(--bg-primary);
            border: 2px solid var(--border);
            max-height: 300px;
            overflow-y: auto;
            display: none;
            box-shadow: 0 10px 30px var(--shadow);
            border-radius: 4px;
        }

        .select-options.show {
            display: block;
        }

        .select-option {
            padding: 1rem 1.5rem;
            cursor: pointer;
            transition: background 0.2s ease;
            text-align: center;
            border-bottom: 1px solid var(--border);
        }

        .select-option:last-child {
            border-bottom: none;
        }

        .select-option:hover {
            background: var(--bg-secondary);
        }

        .select-option.active {
            background: var(--accent);
            color: white;
        }

        /* --- Album Info --- */
        .album-info {
            text-align: center;
            margin-bottom: 2rem;
            position: relative;
            z-index: 1; /* Lower z-index so dropdown goes over it */
        }

        .album-title {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            letter-spacing: 1px;
        }

        .album-subtitle {
            font-size: 1.1rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            font-style: italic;
        }

        .album-description {
            font-size: 0.95rem;
            color: var(--text-secondary);
            max-width: 700px;
            margin: 0 auto;
            line-height: 1.6;
        }

        /* --- Admin Controls --- */
        .admin-controls {
            display: none;
            gap: 0.8rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .admin-controls.visible {
            display: flex;
        }

        /* --- Slideshow --- */
        .slideshow-container {
            position: relative;
            max-width: 100%;
            margin: 0 auto;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            z-index: 1;
        }

        .slide-wrapper {
            position: relative;
            width: 100%;
            height: 60vh;
            min-height: 400px;
            background: var(--bg-secondary);
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            touch-action: pan-y; /* Allow vertical scroll, handle horizontal in JS */
        }

        .slide {
            display: none;
            width: 100%;
            height: 100%;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: 0;
            left: 0;
            opacity: 0;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            user-select: none;
        }

        .slide.active {
            display: flex;
            opacity: 1;
            z-index: 2;
        }

        .slide img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            cursor: zoom-in;
            pointer-events: none; /* Let clicks pass to slide wrapper for swipe logic, handle click manually */
        }
        
        /* Specific fix to allow clicking image */
        .slide-content-click-target {
            pointer-events: auto !important; 
        }

        .slide-controls {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: none;
            gap: 0.5rem;
            z-index: 10;
        }

        .admin-controls.visible ~ .slideshow-container .slide-controls {
            display: flex;
        }

        .slide-btn {
            padding: 0.5rem 0.8rem;
            background: var(--overlay);
            border: none;
            color: white;
            cursor: pointer;
            font-size: 0.75rem;
            transition: background 0.3s ease;
            border-radius: 4px;
        }

        .slide-btn:hover {
            background: var(--accent);
        }

        .nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.3);
            border: none;
            color: white;
            font-size: 2rem;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 5;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-btn:hover {
            background: var(--accent);
        }

        .nav-btn.prev { left: 1rem; }
        .nav-btn.next { right: 1rem; }

        @media (max-width: 768px) {
            .nav-btn { display: none; } /* Hide arrows on mobile, rely on swipe */
        }

        .slide-counter {
            text-align: center;
            margin-top: 1rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
            letter-spacing: 1px;
        }

        /* --- Thumbnails --- */
        .thumbnail-strip {
            display: flex;
            gap: 0.8rem;
            margin-top: 1.5rem;
            overflow-x: auto;
            padding: 0.5rem;
            scrollbar-width: thin;
            scrollbar-color: var(--accent) var(--bg-secondary);
        }

        .thumbnail {
            min-width: 80px;
            height: 60px;
            cursor: pointer;
            opacity: 0.5;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            border-radius: 4px;
            overflow: hidden;
        }

        .thumbnail:hover,
        .thumbnail.active {
            opacity: 1;
            border-color: var(--accent);
        }

        .thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* --- Modals --- */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--overlay);
            z-index: var(--z-modal);
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
            opacity: 1;
        }

        .modal-content {
            background: var(--bg-primary);
            padding: 2.5rem;
            max-width: 500px;
            width: 90%;
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            font-family: 'Playfair Display', serif;
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 1.2rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .form-input,
        .form-textarea {
            width: 100%;
            padding: 0.8rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            font-family: 'Raleway', sans-serif;
            font-size: 1rem;
            border-radius: 4px;
            transition: border-color 0.3s ease;
        }

        .form-input:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            justify-content: flex-end;
        }

        /* --- Lightbox --- */
        .lightbox {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: var(--z-lightbox);
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .lightbox.active {
            display: flex;
            opacity: 1;
        }

        .lightbox-content {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .lightbox-img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            transition: transform 0.1s ease-out;
            user-select: none;
            pointer-events: auto;
        }

        .lightbox-close {
            position: absolute;
            top: 1rem;
            right: 1.5rem;
            background: none;
            border: none;
            color: white;
            font-size: 3rem;
            cursor: pointer;
            padding: 0.5rem;
            line-height: 0.5;
            z-index: 10;
        }

        .lightbox-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: rgba(255,255,255,0.5);
            font-size: 4rem;
            padding: 1rem;
            cursor: pointer;
            transition: color 0.3s ease;
            z-index: 5;
            user-select: none;
        }
        
        .lightbox-nav:hover { color: white; }
        .lightbox-prev { left: 0; }
        .lightbox-next { right: 0; }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .file-upload { display: none; }

        @media (max-width: 600px) {
            .album-title { font-size: 2rem; }
            .header { padding: 1rem; }
            .custom-select { min-width: 100%; }
            .lightbox-nav { display: none; } /* Hide arrows in lightbox on mobile */
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">Gallery</div>
        <div class="header-controls">
            <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle Theme">‚óê</button>
            <button class="btn" id="loginBtn" onclick="showLoginModal()">Admin</button>
            <button class="btn" id="logoutBtn" onclick="logout()" style="display: none;">Logout</button>
        </div>
    </header>

    <div class="container">
        <div class="album-selector-wrapper">
            <div class="custom-select">
                <div class="select-display" onclick="toggleSelect(event)">
                    <span id="selectedAlbum">Select Album</span>
                </div>
                <div class="select-options" id="selectOptions"></div>
            </div>
        </div>

        <div class="album-info">
            <h1 class="album-title" id="albumTitle"></h1>
            <p class="album-subtitle" id="albumSubtitle"></p>
            <p class="album-description" id="albumDescription"></p>
        </div>

        <div class="admin-controls" id="adminControls">
            <button class="btn btn-primary" onclick="showCreateAlbumModal()">Create Album</button>
            <button class="btn" onclick="showEditAlbumModal()">Edit Album</button>
            <button class="btn" onclick="deleteCurrentAlbum()">Delete Album</button>
            <button class="btn" onclick="toggleFavoriteAlbum()">Set as Favorite</button>
            <button class="btn btn-primary" onclick="document.getElementById('photoUpload').click()">Add Photos</button>
            <button class="btn btn-primary" onclick="exportData()">Save Changes</button>
            <input type="file" id="photoUpload" class="file-upload" accept="image/*" multiple onchange="handlePhotoUpload(event)">
        </div>

        <div class="slideshow-container" id="slideshowContainer">
            <div class="slide-wrapper" id="slideWrapper"></div>
            
            <button class="nav-btn prev" onclick="changeSlide(-1)">‚Äπ</button>
            <button class="nav-btn next" onclick="changeSlide(1)">‚Ä∫</button>
            
            <div class="slide-counter" id="slideCounter"></div>
            <div class="thumbnail-strip" id="thumbnailStrip"></div>
        </div>
    </div>

    <div class="modal" id="loginModal">
        <div class="modal-content">
            <h2 class="modal-header">Admin Login</h2>
            <div class="form-group">
                <label class="form-label">Username</label>
                <input type="text" class="form-input" id="username" placeholder="ricajyn">
            </div>
            <div class="form-group">
                <label class="form-label">Password</label>
                <input type="password" class="form-input" id="password" placeholder="Enter password">
            </div>
            <div class="form-actions">
                <button class="btn" onclick="closeModal('loginModal')">Cancel</button>
                <button class="btn btn-primary" onclick="login()">Login</button>
            </div>
        </div>
    </div>

    <div class="modal" id="albumModal">
        <div class="modal-content">
            <h2 class="modal-header" id="albumModalTitle">Create Album</h2>
            <div class="form-group">
                <label class="form-label">Title *</label>
                <input type="text" class="form-input" id="albumTitleInput" placeholder="Enter album title">
            </div>
            <div class="form-group">
                <label class="form-label">Subtitle</label>
                <input type="text" class="form-input" id="albumSubtitleInput" placeholder="Enter subtitle (optional)">
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea class="form-textarea" id="albumDescriptionInput" placeholder="Enter description (optional)"></textarea>
            </div>
            <div class="form-actions">
                <button class="btn" onclick="closeModal('albumModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveAlbum()">Save</button>
            </div>
        </div>
    </div>

    <div class="modal" id="notificationModal">
        <div class="modal-content" style="text-align: center;">
            <div class="notification-icon" id="notificationIcon" style="font-size: 3rem; margin-bottom: 1rem;">‚ÑπÔ∏è</div>
            <p id="notificationMessage" style="margin-bottom: 1.5rem; line-height: 1.5;"></p>
            <button class="btn btn-primary" onclick="closeModal('notificationModal')" style="width: 100%;">OK</button>
        </div>
    </div>

    <div class="lightbox" id="lightbox">
        <button class="lightbox-close" onclick="closeLightbox()">√ó</button>
        <button class="lightbox-nav lightbox-prev" onclick="changeSlide(-1, true)">‚Äπ</button>
        <button class="lightbox-nav lightbox-next" onclick="changeSlide(1, true)">‚Ä∫</button>
        
        <div class="lightbox-content" id="lightboxContent">
            <img class="lightbox-img" id="lightboxImg" src="" alt="">
        </div>
    </div>

    <script>
        // --- DATA SECTION ---
        // ALBUMS_DATA_START
        let ALBUMS_DATA = [
            {
                folderName: "My-Collection",
                title: "My Collection",
                subtitle: "A curated selection",
                description: "Welcome to my photo gallery",
                isFavorite: true,
                photos: []
            }
        ];
        // ALBUMS_DATA_END
        
        // --- CONFIGURATION ---
        // SHA-256 hash for "HisMasterpiece"
        const STORED_PASSWORD_HASH = "b477c78494191393630f9a2634e00b3e6c075024253372274488346e921d701a";
        const ADMIN_USERNAME = 'ricajyn';

        // --- STATE ---
        let albums = [];
        let currentAlbumIndex = 0;
        let currentSlideIndex = 0;
        let isAdmin = false;
        let editingAlbumIndex = null;
        
        // --- TOUCH/SWIPE VARIABLES ---
        let touchStartX = 0;
        let touchEndX = 0;
        let touchStartY = 0;
        const minSwipeDistance = 50; // Minimum px to register as swipe

        // --- INITIALIZATION ---
        async function init() {
            resetToUserMode();
            albums = JSON.parse(JSON.stringify(ALBUMS_DATA));
            
            // Attempt to load photo list if hosted (skipped for local demo/added photos)
            // await loadPhotosFromFolders(); 
            
            // Find favorite album
            const favoriteIndex = albums.findIndex(a => a.isFavorite);
            currentAlbumIndex = favoriteIndex >= 0 ? favoriteIndex : 0;
            
            checkTheme();
            displayAlbumSelector();
            displayCurrentAlbum();
            setupTouchListeners();
        }

        // --- TOUCH GESTURE LOGIC ---
        function setupTouchListeners() {
            const slideWrapper = document.getElementById('slideWrapper');
            const lightboxContent = document.getElementById('lightboxContent');

            // Helper for touch start
            const handleStart = (e) => {
                touchStartX = e.changedTouches[0].screenX;
                touchStartY = e.changedTouches[0].screenY;
            };

            // Helper for touch end
            const handleEnd = (e, isLightbox = false) => {
                touchEndX = e.changedTouches[0].screenX;
                const touchEndY = e.changedTouches[0].screenY;
                
                // Calculate horizontal and vertical difference
                const xDiff = touchStartX - touchEndX;
                const yDiff = touchStartY - touchEndY;

                // Ignore if it was mostly a vertical scroll (for the main page)
                if (!isLightbox && Math.abs(yDiff) > Math.abs(xDiff)) return;

                if (Math.abs(xDiff) > minSwipeDistance) {
                    if (xDiff > 0) {
                        // Swiped Left -> Next Image
                        changeSlide(1, isLightbox);
                    } else {
                        // Swiped Right -> Prev Image
                        changeSlide(-1, isLightbox);
                    }
                }
            };

            // Add listeners to Main Slider
            slideWrapper.addEventListener('touchstart', handleStart, {passive: true});
            slideWrapper.addEventListener('touchend', (e) => handleEnd(e, false), {passive: true});

            // Add listeners to Lightbox
            lightboxContent.addEventListener('touchstart', handleStart, {passive: true});
            lightboxContent.addEventListener('touchend', (e) => handleEnd(e, true), {passive: true});
        }

        // --- DISPLAY LOGIC ---
        function displayAlbumSelector() {
            const options = document.getElementById('selectOptions');
            const display = document.getElementById('selectedAlbum');
            options.innerHTML = '';
            
            albums.forEach((album, index) => {
                const option = document.createElement('div');
                option.className = 'select-option' + (index === currentAlbumIndex ? ' active' : '');
                option.textContent = album.title + (album.isFavorite ? ' ‚òÖ' : '');
                option.onclick = (e) => {
                    e.stopPropagation(); // Stop bubbling
                    selectAlbum(index);
                };
                options.appendChild(option);
            });

            const currentAlbum = albums[currentAlbumIndex];
            if (currentAlbum) {
                display.textContent = currentAlbum.title + (currentAlbum.isFavorite ? ' ‚òÖ' : '');
            }
        }

        function toggleSelect(e) {
            e.stopPropagation();
            const options = document.getElementById('selectOptions');
            const display = document.querySelector('.select-display');
            
            const isVisible = options.classList.contains('show');
            
            if (isVisible) {
                options.classList.remove('show');
                display.classList.remove('open');
            } else {
                // Close others if any (though we only have one)
                options.classList.add('show');
                display.classList.add('open');
            }
        }

        function selectAlbum(index) {
            currentAlbumIndex = index;
            currentSlideIndex = 0;
            
            // Close dropdown
            const options = document.getElementById('selectOptions');
            const display = document.querySelector('.select-display');
            options.classList.remove('show');
            display.classList.remove('open');
            
            displayAlbumSelector();
            displayCurrentAlbum();
        }

        function displayCurrentAlbum() {
            const album = albums[currentAlbumIndex];
            
            // Clear or Set Info
            if (!album) {
                document.getElementById('albumTitle').textContent = 'No Album Selected';
                document.getElementById('slideWrapper').innerHTML = '';
                return;
            }

            document.getElementById('albumTitle').textContent = album.title;
            document.getElementById('albumSubtitle').textContent = album.subtitle || '';
            document.getElementById('albumDescription').textContent = album.description || '';

            const wrapper = document.getElementById('slideWrapper');
            wrapper.innerHTML = '';

            // Handle Empty Album
            if (!album.photos || album.photos.length === 0) {
                wrapper.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì∑</div>
                        <p>No photos in this album yet.</p>
                        ${isAdmin ? '<p style="margin-top:1rem; font-size:0.8rem;">Click "Add Photos" to upload.</p>' : ''}
                    </div>
                `;
                document.getElementById('thumbnailStrip').innerHTML = '';
                document.getElementById('slideCounter').style.display = 'none';
                return;
            }

            // Render Slides
            album.photos.forEach((photoName, index) => {
                // Determine source: If it looks like a base64 or full URL, use it, else assume relative path
                let imgSrc = photoName;
                if (!photoName.startsWith('data:') && !photoName.startsWith('http')) {
                    imgSrc = `images/${album.folderName}/${photoName}`;
                }

                const slide = document.createElement('div');
                slide.className = 'slide' + (index === currentSlideIndex ? ' active' : '');
                
                // Internal HTML
                let html = `<img src="${imgSrc}" class="slide-content-click-target" alt="Photo ${index+1}" onclick="openLightbox(this.src)">`;
                
                // Admin Controls on Slide
                if (isAdmin) {
                    html += `
                    <div class="slide-controls">
                        ${index > 0 ? `<button class="slide-btn" onclick="event.stopPropagation(); movePhoto(${index}, -1)">‚Üê</button>` : ''}
                        ${index < album.photos.length - 1 ? `<button class="slide-btn" onclick="event.stopPropagation(); movePhoto(${index}, 1)">‚Üí</button>` : ''}
                        <button class="slide-btn" style="background:#d32f2f;" onclick="event.stopPropagation(); deletePhoto(${index})">Del</button>
                    </div>`;
                }
                
                slide.innerHTML = html;
                wrapper.appendChild(slide);
            });

            updateSlideCounter();
            displayThumbnails(album);
        }

        function displayThumbnails(album) {
            const strip = document.getElementById('thumbnailStrip');
            strip.innerHTML = '';

            album.photos.forEach((photoName, index) => {
                let imgSrc = photoName;
                if (!photoName.startsWith('data:') && !photoName.startsWith('http')) {
                    imgSrc = `images/${album.folderName}/${photoName}`;
                }

                const thumb = document.createElement('div');
                thumb.className = 'thumbnail' + (index === currentSlideIndex ? ' active' : '');
                thumb.innerHTML = `<img src="${imgSrc}" loading="lazy" alt="Thumb">`;
                thumb.onclick = () => {
                    currentSlideIndex = index;
                    showSlide();
                };
                strip.appendChild(thumb);
            });
        }

        // --- NAVIGATION ---
        function changeSlide(direction, isLightbox = false) {
            const album = albums[currentAlbumIndex];
            if (!album || !album.photos || album.photos.length === 0) return;

            currentSlideIndex += direction;
            
            // Loop functionality
            if (currentSlideIndex < 0) currentSlideIndex = album.photos.length - 1;
            if (currentSlideIndex >= album.photos.length) currentSlideIndex = 0;

            showSlide();

            // If lightbox is active, update it too
            if (document.getElementById('lightbox').classList.contains('active')) {
                const currentImg = album.photos[currentSlideIndex];
                let imgSrc = currentImg;
                if (!currentImg.startsWith('data:') && !currentImg.startsWith('http')) {
                    imgSrc = `images/${album.folderName}/${currentImg}`;
                }
                document.getElementById('lightboxImg').src = imgSrc;
            }
        }

        function showSlide() {
            const slides = document.querySelectorAll('.slide');
            const thumbnails = document.querySelectorAll('.thumbnail');
            
            slides.forEach((slide, index) => {
                slide.classList.remove('active');
                if (index === currentSlideIndex) {
                    slide.classList.add('active');
                }
            });

            thumbnails.forEach((thumb, index) => {
                thumb.classList.toggle('active', index === currentSlideIndex);
                if (index === currentSlideIndex) {
                    thumb.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                }
            });

            updateSlideCounter();
        }

        function updateSlideCounter() {
            const album = albums[currentAlbumIndex];
            const counter = document.getElementById('slideCounter');
            if (album && album.photos.length > 0) {
                counter.textContent = `${currentSlideIndex + 1} / ${album.photos.length}`;
                counter.style.display = 'block';
            } else {
                counter.style.display = 'none';
            }
        }

        // --- AUTHENTICATION ---
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hash = await crypto.subtle.digest('SHA-256', data);
            return Array.from(new Uint8Array(hash))
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
        }

        async function login() {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;

            if (u !== ADMIN_USERNAME) {
                showNotification('Invalid credentials', '‚ùå');
                return;
            }

            const hash = await hashPassword(p);
            
            if (hash === STORED_PASSWORD_HASH) {
                isAdmin = true;
                document.getElementById('loginBtn').style.display = 'none';
                document.getElementById('logoutBtn').style.display = 'block';
                document.getElementById('adminControls').classList.add('visible');
                closeModal('loginModal');
                
                // Refresh view to show admin buttons on slides
                displayCurrentAlbum();
                
                showNotification('Welcome back, Admin!', '‚úÖ');
                
                // Clear fields
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
            } else {
                showNotification('Invalid credentials', '‚ùå');
            }
        }

        function logout() {
            isAdmin = false;
            resetToUserMode();
            displayCurrentAlbum(); // Refresh to hide admin buttons
            showNotification('Logged out successfully', 'üëã');
        }

        function resetToUserMode() {
            document.getElementById('loginBtn').style.display = 'block';
            document.getElementById('logoutBtn').style.display = 'none';
            document.getElementById('adminControls').classList.remove('visible');
        }

        // --- ADMIN FUNCTIONS ---
        function saveAlbum() {
            const title = document.getElementById('albumTitleInput').value.trim();
            if (!title) {
                alert('Title is required');
                return;
            }

            const subtitle = document.getElementById('albumSubtitleInput').value.trim();
            const description = document.getElementById('albumDescriptionInput').value.trim();
            const folderName = title.replace(/[^a-zA-Z0-9]/g, '-');

            if (editingAlbumIndex !== null) {
                // Edit existing
                albums[editingAlbumIndex].title = title;
                albums[editingAlbumIndex].subtitle = subtitle;
                albums[editingAlbumIndex].description = description;
                // Note: We don't change folderName usually to avoid breaking paths, 
                // but for new albums it's fine.
            } else {
                // Create new
                albums.push({
                    folderName: folderName,
                    title: title,
                    subtitle: subtitle,
                    description: description,
                    photos: [],
                    isFavorite: false
                });
                currentAlbumIndex = albums.length - 1;
            }

            closeModal('albumModal');
            displayAlbumSelector();
            displayCurrentAlbum();
        }

        function deleteCurrentAlbum() {
            if (albums.length <= 1) {
                showNotification("Cannot delete the only album.");
                return;
            }
            if (confirm("Are you sure you want to delete this album?")) {
                albums.splice(currentAlbumIndex, 1);
                currentAlbumIndex = 0;
                displayAlbumSelector();
                displayCurrentAlbum();
            }
        }

        function toggleFavoriteAlbum() {
            albums.forEach(a => a.isFavorite = false);
            albums[currentAlbumIndex].isFavorite = true;
            displayAlbumSelector();
            showNotification("Set as Favorite Album", "‚≠ê");
        }

        function handlePhotoUpload(event) {
            const files = event.target.files;
            if (!files.length || !albums[currentAlbumIndex]) return;

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    // For client-side demo, we use Base64. 
                    // In real hosting, you'd want to upload these and use filenames.
                    // But since there is no backend, Base64 allows immediate viewing.
                    // WARNING: Base64 bloats the HTML file significantly.
                    // Ideally, user puts files in folder and adds filenames manually, 
                    // but for this UI request, we render the result.
                    albums[currentAlbumIndex].photos.push(e.target.result);
                    displayCurrentAlbum();
                };
                reader.readAsDataURL(file);
            });
            
            showNotification("Photos added! Remember to Save Changes.", "üíæ");
            event.target.value = ''; // Reset input
        }

        function movePhoto(index, dir) {
            const arr = albums[currentAlbumIndex].photos;
            const newIndex = index + dir;
            [arr[index], arr[newIndex]] = [arr[newIndex], arr[index]];
            // Follow the photo
            if (currentSlideIndex === index) currentSlideIndex = newIndex;
            else if (currentSlideIndex === newIndex) currentSlideIndex = index;
            displayCurrentAlbum();
        }

        function deletePhoto(index) {
            if(confirm("Remove this photo?")) {
                albums[currentAlbumIndex].photos.splice(index, 1);
                if (currentSlideIndex >= albums[currentAlbumIndex].photos.length) {
                    currentSlideIndex = Math.max(0, albums[currentAlbumIndex].photos.length - 1);
                }
                displayCurrentAlbum();
            }
        }

        // --- EXPORT ---
        function exportData() {
            // We need to inject the current 'albums' array back into the HTML string
            // so the user can download the updated file.
            const currentHTML = document.documentElement.outerHTML;
            const jsonString = JSON.stringify(albums, null, 4);
            
            // Regex to replace the JSON block
            const regex = /\/\/ ALBUMS_DATA_START[\s\S]*?\/\/ ALBUMS_DATA_END/;
            const newContent = `// ALBUMS_DATA_START\n        let ALBUMS_DATA = ${jsonString};\n        // ALBUMS_DATA_END`;
            
            const updatedHTML = currentHTML.replace(regex, newContent);
            
            const blob = new Blob([updatedHTML], {type: 'text/html'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'index.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification("File downloaded! Upload this to GitHub.", "‚úÖ");
        }

        // --- UI HELPERS ---
        function showLoginModal() {
            document.getElementById('loginModal').classList.add('active');
        }

        function showCreateAlbumModal() {
            editingAlbumIndex = null;
            document.getElementById('albumModalTitle').textContent = "Create Album";
            document.getElementById('albumTitleInput').value = "";
            document.getElementById('albumSubtitleInput').value = "";
            document.getElementById('albumDescriptionInput').value = "";
            document.getElementById('albumModal').classList.add('active');
        }

        function showEditAlbumModal() {
            const alb = albums[currentAlbumIndex];
            editingAlbumIndex = currentAlbumIndex;
            document.getElementById('albumModalTitle').textContent = "Edit Album";
            document.getElementById('albumTitleInput').value = alb.title;
            document.getElementById('albumSubtitleInput').value = alb.subtitle;
            document.getElementById('albumDescriptionInput').value = alb.description;
            document.getElementById('albumModal').classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function showNotification(msg, icon="‚ÑπÔ∏è") {
            document.getElementById('notificationIcon').textContent = icon;
            document.getElementById('notificationMessage').textContent = msg;
            document.getElementById('notificationModal').classList.add('active');
        }

        // Lightbox
        function openLightbox(src) {
            document.getElementById('lightboxImg').src = src;
            document.getElementById('lightbox').classList.add('active');
        }
        
        function closeLightbox() {
            document.getElementById('lightbox').classList.remove('active');
        }

        // Theme
        function toggleTheme() {
            const html = document.documentElement;
            const cur = html.getAttribute('data-theme');
            const next = cur === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
        }

        function checkTheme() {
            const saved = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', saved);
        }

        // Global Event for closing Dropdown
        document.addEventListener('click', (e) => {
            const select = document.querySelector('.custom-select');
            if (select && !select.contains(e.target)) {
                document.getElementById('selectOptions').classList.remove('show');
                document.querySelector('.select-display').classList.remove('open');
            }
        });

        // Key Listeners
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') {
                const isLightbox = document.getElementById('lightbox').classList.contains('active');
                changeSlide(-1, isLightbox);
            }
            if (e.key === 'ArrowRight') {
                const isLightbox = document.getElementById('lightbox').classList.contains('active');
                changeSlide(1, isLightbox);
            }
            if (e.key === 'Escape') {
                closeLightbox();
                closeModal('loginModal');
                closeModal('albumModal');
                closeModal('notificationModal');
            }
        });

        // Start
        window.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
